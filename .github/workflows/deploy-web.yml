name: Deploy Splitly Web to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'web/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Web to Production Server
    runs-on: ubuntu-latest
    
    permissions:
      deployments: write
      contents: read
      statuses: write
    
    environment:
      name: production-web
      url: https://splitly.khangdev.me
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start Deployment
        uses: bobheadxi/deployments@v1
        id: deployment
        with:
          step: start
          token: ${{ secrets.GITHUB_TOKEN }}
          env: production-web
          ref: ${{ github.sha }}
      
      - name: Deploy Web to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 180s
          script: |
            # Navigate to project directory and pull latest changes
            cd ~/splitly
            git fetch origin
            git reset --hard origin/main
            
            # Navigate to web directory
            cd ~/splitly/web
            
            # Install dependencies
            npm ci --production=false
            
            # Build the project for production
            npm run build
            
            # Backup current deployment
            sudo cp -r /var/www/splitly /var/www/splitly-backup-$(date +%Y%m%d-%H%M%S) || true
            
            # Copy built files to nginx directory
            sudo rm -rf /var/www/splitly/*
            sudo cp -r dist/* /var/www/splitly/
            sudo chown -R www-data:www-data /var/www/splitly
            sudo chmod -R 755 /var/www/splitly
            
            # Test nginx configuration and reload
            sudo nginx -t
            if [ $? -eq 0 ]; then
                sudo systemctl reload nginx
                echo "‚úÖ Nginx reloaded successfully"
            else
                echo "‚ùå Nginx configuration test failed"
                exit 1
            fi
            
            # Verify deployment
            echo "üìÅ Deployed files:"
            ls -la /var/www/splitly/
            
            # Test if the site is accessible
            if curl -f -s http://localhost > /dev/null; then
                echo "‚úÖ Web deployment completed and site is accessible!"
            else
                echo "‚ö†Ô∏è  Deployment completed but site may not be accessible"
            fi
      
      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60s
          script: |
            echo "üîç Final verification..."
            echo "Current files in web directory:"
            ls -la /var/www/splitly/ | head -10
            echo ""
            echo "Checking if index.html exists and is recent:"
            if [ -f /var/www/splitly/index.html ]; then
                echo "‚úÖ index.html found"
                echo "Last modified: $(stat -c %y /var/www/splitly/index.html)"
            else
                echo "‚ùå index.html not found!"
            fi
      
      - name: Update Deployment Status
        uses: bobheadxi/deployments@v1
        if: always()
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          status: ${{ job.status }}
          env: production-web
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
          env_url: https://splitly.khangdev.me